<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë™ë¬¼ìƒ ì°¾ê¸° (ì˜¤ë¥˜ìˆ˜ì •íŒ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        /* ìŠ¤íƒ€ì¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ */
        body { font-family: 'Jua', sans-serif; background-color: #fff0f5; background-image: radial-gradient(#ffb7b2 20%, transparent 20%), radial-gradient(#ffb7b2 20%, transparent 20%); background-position: 0 0, 10px 10px; background-size: 20px 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; color: #5d4037; }
        .container { background-color: #ffffff; padding: 40px; border-radius: 30px; box-shadow: 0 10px 25px rgba(255, 105, 180, 0.3); text-align: center; width: 90%; max-width: 420px; position: relative; border: 5px dashed #ffdac1; }
        h1 { margin: 10px 0; font-size: 2.5rem; color: #ff6f61; }
        h2 { margin: 0 0 25px; font-size: 1.2rem; color: #888; font-weight: normal; }
        .btn { background: linear-gradient(to bottom, #ff9a9e, #fad0c4); color: white; border: none; padding: 15px 40px; font-size: 1.5rem; font-family: 'Jua', sans-serif; border-radius: 50px; cursor: pointer; transition: all 0.2s; box-shadow: 0 6px 0 #ef8088; margin-top: 10px; }
        .btn:hover { transform: translateY(2px); box-shadow: 0 4px 0 #ef8088; }
        .btn:active { transform: translateY(6px); box-shadow: none; }
        .btn-retry { background: linear-gradient(to bottom, #a1c4fd, #c2e9fb); box-shadow: 0 6px 0 #89b0ea; font-size: 1.2rem; margin-top: 20px; }
        .btn-retry:hover { box-shadow: 0 4px 0 #89b0ea; }
        .webcam-wrapper { position: relative; width: 300px; height: 300px; margin: 20px auto; border-radius: 50%; border: 8px solid #ffdac1; overflow: hidden; display: none; background-color: #fff; }
        #webcam-container canvas { width: 100%; height: 100%; object-fit: cover; }
        #countdown-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 120px; color: #fff; -webkit-text-stroke: 3px #ff6f61; font-weight: bold; display: none; z-index: 10; }
        #result-area { display: none; margin-top: 25px; background-color: #fff9f0; padding: 20px; border-radius: 20px; }
        .result-title { font-size: 1.8rem; color: #ff6f61; margin-bottom: 15px; }
        .label-wrapper { margin-bottom: 12px; text-align: left; }
        .progress-bg { background-color: #eee; border-radius: 15px; height: 30px; width: 100%; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; width: 0%; transition: width 1s ease; display: flex; align-items: center; justify-content: flex-end; border-radius: 15px; }
        .progress-text { color: white; font-size: 1rem; font-weight: bold; padding-right: 12px; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>ë™ë¬¼ìƒ ì°¾ê¸°</h1>
        <h2 id="status-msg">ë‚˜ëŠ” ì–´ë–¤ ë™ë¬¼ì„ ë‹®ì•˜ì„ê¹Œ?</h2>
        
        <div id="control-area">
            <button class="btn" id="start-btn" onclick="init()">ì‹œì‘í•˜ê¸°!</button>
        </div>

        <div class="webcam-wrapper" id="webcam-wrapper">
            <div id="countdown-text">3</div>
            <div id="webcam-container"></div>
        </div>

        <div id="result-area">
            <div class="result-title" id="result-title"></div>
            <div id="label-container"></div>
            <button class="btn btn-retry" onclick="retry()">ë‹¤ì‹œ í•´ë³¼ë˜!</button>
        </div>
    </div>
    
    <audio id="shutter-sound" src="https://actions.google.com/sounds/v1/cartoon/camera_shutter.ogg"></audio>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    
    <script type="text/javascript">
        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ ì£¼ì†Œ í™•ì¸ í•„ìˆ˜ â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        const URL = "https://teachablemachine.withgoogle.com/models/y9sxqkYAO/";
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        let model, webcam, maxPredictions;
        let isModelLoaded = false;
        let loopId;

        async function init() {
            const startBtn = document.getElementById("start-btn");
            
            // 1. ë²„íŠ¼ ë°˜ì‘ í™•ì¸
            console.log("ì‹œì‘í•˜ê¸° ë²„íŠ¼ í´ë¦­ë¨"); 
            startBtn.innerText = "ë¡œë”© ì¤‘...";
            startBtn.classList.add("blink");
            startBtn.disabled = true;

            try {
                // 2. ëª¨ë¸ ë¡œë”© ì‹œë„
                if(!isModelLoaded) {
                    const modelURL = URL + "model.json";
                    const metadataURL = URL + "metadata.json";
                    console.log("ëª¨ë¸ ë¡œë”© ì‹œì‘: " + modelURL);
                    model = await tmImage.load(modelURL, metadataURL);
                    maxPredictions = model.getTotalClasses();
                    isModelLoaded = true;
                    console.log("ëª¨ë¸ ë¡œë”© ì„±ê³µ");
                }

                // 3. ì›¹ìº  ì„¤ì • ì‹œë„
                const flip = true; 
                webcam = new tmImage.Webcam(300, 300, flip); 
                await webcam.setup(); 
                console.log("ì›¹ìº  ì„¤ì • ì„±ê³µ");
                await webcam.play();
                window.requestAnimationFrame(loop);

                document.getElementById("webcam-container").innerHTML = "";
                document.getElementById("webcam-container").appendChild(webcam.canvas);
                
                document.getElementById("webcam-wrapper").style.display = "block";
                startBtn.style.display = "none";
                document.getElementById("status-msg").innerText = "ì¹´ë©”ë¼ë¥¼ ë´ì£¼ì„¸ìš”! ì¹˜~ì¦ˆ âœŒï¸";
                
                const controlArea = document.getElementById("control-area");
                controlArea.style.display = "block";
                controlArea.innerHTML = '<button class="btn" onclick="startCountdown()">ì‚¬ì§„ ì°ê¸° ğŸ“¸</button>';

            } catch (error) {
                // 4. ì˜¤ë¥˜ ì¡ê¸°
                console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!\n\nì›ì¸: " + error.message + "\n\n(ëª¨ë¸ ì£¼ì†Œê°€ ì •í™•í•œì§€, ì¹´ë©”ë¼ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”)");
                startBtn.innerText = "ì‹œì‘í•˜ê¸°!";
                startBtn.classList.remove("blink");
                startBtn.disabled = false;
            }
        }

        async function loop() {
            webcam.update();
            loopId = window.requestAnimationFrame(loop);
        }

        function speak(text) {
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel(); 
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR'; 
                utterance.rate = 1.2; 
                window.speechSynthesis.speak(utterance);
            }
        }

        function startCountdown() {
            const countdownElem = document.getElementById("countdown-text");
            const btnArea = document.getElementById("control-area");
            
            btnArea.style.display = "none";
            countdownElem.style.display = "block";
            
            let count = 3;
            countdownElem.innerText = count;
            speak("ì‚¼"); 

            const timer = setInterval(() => {
                count--;
                if(count > 0) {
                    countdownElem.innerText = count;
                    if(count === 2) speak("ì´");
                    if(count === 1) speak("ì¼");
                } else {
                    clearInterval(timer);
                    countdownElem.style.display = "none";
                    playShutter(); 
                    predict();
                }
            }, 1000); 
        }

        function playShutter() {
            const audio = document.getElementById("shutter-sound");
            audio.currentTime = 0; 
            audio.play().catch(e => console.log("ì†Œë¦¬ ì¬ìƒ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ì •ì±…):", e));
        }

        async function predict() {
            await webcam.stop();
            if(loopId) {
                window.cancelAnimationFrame(loopId);
                loopId = null;
            }
            
            const prediction = await model.predict(webcam.canvas);
            
            if(!prediction || prediction.length === 0) {
                alert("ì–¼êµ´ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”!");
                retry();
                return;
            }

            prediction.sort((a, b) => parseFloat(b.probability) - parseFloat(a.probability));
            const bestClass = prediction[0].className;
            const bestScore = (prediction[0].probability * 100).toFixed(0);

            document.getElementById("result-title").innerHTML = `ì™€! <span style="color:#ff6b6b">${bestClass}</span>ì„(ë¥¼)<br>${bestScore}% ë‹®ì•˜ì–´ìš”!`;
            document.getElementById("status-msg").innerText = "ê²°ê³¼ê°€ ë‚˜ì™”ì–´ìš”!";

            const labelContainer = document.getElementById("label-container");
            labelContainer.innerHTML = "";
            const colors = ["#ff9a9e", "#a18cd1", "#fad0c4", "#84fab0"];

            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction = prediction[i].className;
                const probability = (prediction[i].probability * 100).toFixed(1);
                const color = colors[i % colors.length];

                const html = `
                    <div class="label-wrapper">
                        <span class="label-name">${classPrediction}</span>
                        <div class="progress-bg">
                            <div class="progress-bar" style="width: ${probability}%; background: ${color};">
                                <span class="progress-text">${probability}%</span>
                            </div>
                        </div>
                    </div>
                `;
                labelContainer.innerHTML += html;
            }
            document.getElementById("result-area").style.display = "block";
        }

        async function retry() {
            document.getElementById("result-area").style.display = "none";
            document.getElementById("webcam-wrapper").style.display = "block";
            document.getElementById("status-msg").innerText = "ë‹¤ì‹œ í•œë²ˆ ì°ì–´ë³¼ê¹Œìš”? âœŒï¸";
            
            const controlArea = document.getElementById("control-area");
            controlArea.style.display = "block";

            await webcam.play();
            if(!loopId) {
                window.requestAnimationFrame(loop);
            }
        }
    </script>
</body>
</html>